# Daily Digest Command

You are executing the daily digest command. Follow these steps precisely to generate an AI-ranked digest of articles from Substack feeds.

## Parse Command Flags

Check if the user provided any flags:
- `--test`: Set TEST_MODE = true (don't save digest)
- `--reauth`: Set REAUTH = true (force re-authentication)

If no flags are provided, use defaults (TEST_MODE = false, REAUTH = false).

## Step-by-Step Execution

### Step 1: Load Configuration Files

Use the Read tool to load:
1. Read `${CLAUDE_PLUGIN_ROOT}/config/interest-profile.yaml`
   - Parse the YAML to extract: topics, questions, areas_of_focus, do_not_want
   - Store in memory for evaluation prompts

2. Read `${CLAUDE_PLUGIN_ROOT}/config/sources.yaml`
   - Parse the YAML to extract: Substack feed URLs and scraping parameters
   - Note: `${CLAUDE_PLUGIN_ROOT}` = `/Users/ryan.lucht/.claude/plugins/daily-digest-plugin`

If files cannot be read, report error and exit.

### Step 2: Handle Authentication

Check authentication status:

1. If REAUTH = true, call MCP tool:
   ```
   mcp__daily-digest-feed-scraper__perform_login
   service: "substack"
   ```
   Wait for user to complete browser login.

2. Otherwise, proceed with existing auth (tool will handle loading saved state)

### Step 3: Fetch Articles from Substack

Call the MCP tool to fetch articles:
```
mcp__daily-digest-feed-scraper__fetch_substack_feed
url: "https://substack.com/home"
posts_to_scrape: 40
use_auth: true
```

The tool will return a JSON response with an array of articles. Each article has:
- title: string
- url: string
- author: string
- date: Date
- summary: string
- source: "substack"

Parse the response and store the articles array.

If error occurs (e.g., "No saved authentication"), report it and suggest user run with `--reauth`.

### Step 4: Evaluate Each Article with AI

For each article in the articles array:

1. **Construct evaluation prompt**:

```
You are evaluating an article for relevance to the user's interest profile.

**Article:**
- Title: {article.title}
- Author: {article.author}
- Summary: {article.summary}
- URL: {article.url}

**User's Interest Profile:**

Topics:
{list all topics from interest-profile.yaml}

Key Questions:
{list all questions from interest-profile.yaml}

Areas of Focus:
{list all areas_of_focus from interest-profile.yaml}

Things to Avoid (anti-interests):
{list all items from do_not_want in interest-profile.yaml}

**Task:**
Holistically evaluate this article's relevance to the user's interests. Consider:
- Topic alignment: How well does it match stated topics?
- Question relevance: Does it help answer key questions?
- Novelty: Does it present new insights?
- Quality: Is it substantive and well-written?
- Anti-interest filter: Does it touch on topics to avoid?

**Response Format:**
Provide a JSON response with:
{
  "score": <number 0-10>,
  "reasoning": "<1-2 sentence explanation of why this score>"
}

Score 0-3: Not relevant or touches anti-interests
Score 4-6: Somewhat relevant
Score 7-8: Highly relevant
Score 9-10: Exceptionally relevant and insightful
```

2. **Send this prompt to Claude** (use current conversation context to evaluate)

3. **Parse the JSON response** to extract score and reasoning

4. **Store result**: Add `score` and `reasoning` fields to the article object

**Note**: For efficiency, consider batching evaluations if possible, but ensure each article gets its own score.

### Step 5: Rank and Select Top 5

1. Sort articles by `score` field (descending, highest first)
2. Take the top 5 articles
3. If there are ties at position 5, include all tied articles

### Step 6: Generate Markdown Digest

Create the digest content using this template:

```markdown
# Daily Digest - {current date: Month DD, YYYY}

Generated from {total_count} articles evaluated against your interest profile.

---

## ü•á #1: [{article.title}]({article.url})
**Author**: {article.author} | **Source**: Substack | **Score**: {article.score}/10

**Why it matters**: {article.reasoning}

**Summary**: {article.summary}

---

## ü•à #2: [{title}]({url})
...

(repeat for top 5)

---

*Generated by Daily Digest Plugin for Claude Code*
*Your interests: {list top 3 topics from profile}*
```

### Step 7: Save Digest File

**If TEST_MODE = false:**
1. Use Write tool to save the digest:
   - File path: `/Users/ryan.lucht/.claude/plugins/daily-digest-plugin/digests/digest-{YYYY-MM-DD}.md`
   - Content: the markdown generated in Step 6

**If TEST_MODE = true:**
1. Display the digest content to user
2. Print message: "TEST MODE: Digest not saved"

### Step 8: Print Execution Summary

Display final statistics to user:

```
‚úÖ Daily Digest Complete!

üìä Statistics:
- Articles evaluated: {total_count}
- Top score: {highest_score}/10
- File saved: digests/digest-{YYYY-MM-DD}.md

üèÜ Top 3 Articles:
1. {title_1} ({score_1}/10)
2. {title_2} ({score_2}/10)
3. {title_3} ({score_3}/10)
```

## Error Handling

If any step fails:
- **Authentication error**: "No saved authentication. Please run: /daily-digest --reauth"
- **Config file missing**: "Configuration file not found at {path}"
- **No articles returned**: "No articles found. Check your sources.yaml configuration"
- **MCP tool error**: Display the error message from the tool

For any error, stop execution and report clearly to user.
